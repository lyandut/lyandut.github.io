<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>智能指针shared_ptr踩坑笔记 | 回廊识路</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content="Perfer et obdura; dolor hic tibi proderit olim.">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/assets/css/0.styles.ece217d8.css" as="style"><link rel="preload" href="/assets/js/app.dd25fc47.js" as="script"><link rel="preload" href="/assets/js/3.ea75390b.js" as="script"><link rel="preload" href="/assets/js/1.09e6effb.js" as="script"><link rel="preload" href="/assets/js/17.6526aea9.js" as="script"><link rel="prefetch" href="/assets/js/10.3ddd2f87.js"><link rel="prefetch" href="/assets/js/11.cbe366c6.js"><link rel="prefetch" href="/assets/js/12.9c3da036.js"><link rel="prefetch" href="/assets/js/13.802bad9e.js"><link rel="prefetch" href="/assets/js/14.00a3ca7f.js"><link rel="prefetch" href="/assets/js/15.1865061d.js"><link rel="prefetch" href="/assets/js/16.7a0b66bc.js"><link rel="prefetch" href="/assets/js/18.e4bd4232.js"><link rel="prefetch" href="/assets/js/19.ee4baa0d.js"><link rel="prefetch" href="/assets/js/20.0a035f0b.js"><link rel="prefetch" href="/assets/js/21.d346b4b4.js"><link rel="prefetch" href="/assets/js/22.9dca4305.js"><link rel="prefetch" href="/assets/js/23.01332d42.js"><link rel="prefetch" href="/assets/js/24.b2a91720.js"><link rel="prefetch" href="/assets/js/25.a88e114d.js"><link rel="prefetch" href="/assets/js/26.ac2a3f14.js"><link rel="prefetch" href="/assets/js/27.72c490ab.js"><link rel="prefetch" href="/assets/js/28.748efcbb.js"><link rel="prefetch" href="/assets/js/4.19881b30.js"><link rel="prefetch" href="/assets/js/5.88072897.js"><link rel="prefetch" href="/assets/js/6.5a6c99de.js"><link rel="prefetch" href="/assets/js/7.0068c096.js"><link rel="prefetch" href="/assets/js/8.214347f8.js"><link rel="prefetch" href="/assets/js/9.88812e23.js">
    <link rel="stylesheet" href="/assets/css/0.styles.ece217d8.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-1aefc0b4><div data-v-1aefc0b4><div id="loader-wrapper" class="loading-wrapper" data-v-d48f4d20 data-v-1aefc0b4 data-v-1aefc0b4><div class="loader-main" data-v-d48f4d20><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-25ba6db2 data-v-1aefc0b4 data-v-1aefc0b4><h3 class="title" data-v-25ba6db2 data-v-25ba6db2>回廊识路</h3> <p class="description" data-v-25ba6db2 data-v-25ba6db2>Perfer et obdura; dolor hic tibi proderit olim.</p> <label id="box" class="inputBox" data-v-25ba6db2 data-v-25ba6db2><input type="password" value="" data-v-25ba6db2> <span data-v-25ba6db2>Konck! Knock!</span> <button data-v-25ba6db2>OK</button></label> <div class="footer" data-v-25ba6db2 data-v-25ba6db2><span data-v-25ba6db2><i class="iconfont reco-theme" data-v-25ba6db2></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-25ba6db2>vuePress-theme-reco</a></span> <span data-v-25ba6db2><i class="iconfont reco-copyright" data-v-25ba6db2></i> <a data-v-25ba6db2><span data-v-25ba6db2>回廊识路</span>
            
          <!---->
          2022
        </a></span></div></div> <div class="hide" data-v-1aefc0b4><header class="navbar" data-v-1aefc0b4><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/head.png" alt="回廊识路" class="logo"> <span class="site-name">回廊识路</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      编程之路
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/Algorithm/" class="nav-link"><i class="undefined"></i>
  Algorithm
</a></li><li class="dropdown-item"><!----> <a href="/categories/C++/" class="nav-link"><i class="undefined"></i>
  C++
</a></li><li class="dropdown-item"><!----> <a href="/categories/Operational Research/" class="nav-link"><i class="undefined"></i>
  Operational Research
</a></li><li class="dropdown-item"><!----> <a href="/categories/Python/" class="nav-link"><i class="undefined"></i>
  Python
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签云
</a></div><div class="nav-item"><a href="/essay/" class="nav-link"><i class="iconfont reco-suggestion"></i>
  随笔
</a></div><div class="nav-item"><a href="/tools/" class="nav-link"><i class="iconfont reco-search"></i>
  工具
</a></div><div class="nav-item"><a href="/timeLine/" class="nav-link"><i class="iconfont reco-date"></i>
  时间线
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      联系我
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/lyandut" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://blog.csdn.net/llllllyyy" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-csdn"></i>
  CSDN
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://www.zhihu.com/people/li-yan-44-55-45" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-zhihu"></i>
  知乎
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <a href="https://github.com/lyandut/MyVuepressBlog" target="_blank" rel="noopener noreferrer" class="repo-link"><i class="iconfont reco-github"></i>
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask" data-v-1aefc0b4></div> <aside class="sidebar" data-v-1aefc0b4><div class="personal-info-wrapper" data-v-39576ba9 data-v-1aefc0b4><img src="/head.png" alt="author-avatar" class="personal-img" data-v-39576ba9> <h3 class="name" data-v-39576ba9>
    回廊识路
  </h3> <div class="num" data-v-39576ba9><div data-v-39576ba9><h3 data-v-39576ba9>18</h3> <h6 data-v-39576ba9>Articles</h6></div> <div data-v-39576ba9><h3 data-v-39576ba9>7</h3> <h6 data-v-39576ba9>Tags</h6></div></div> <ul class="social-links" data-v-39576ba9></ul> <hr data-v-39576ba9></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      编程之路
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/Algorithm/" class="nav-link"><i class="undefined"></i>
  Algorithm
</a></li><li class="dropdown-item"><!----> <a href="/categories/C++/" class="nav-link"><i class="undefined"></i>
  C++
</a></li><li class="dropdown-item"><!----> <a href="/categories/Operational Research/" class="nav-link"><i class="undefined"></i>
  Operational Research
</a></li><li class="dropdown-item"><!----> <a href="/categories/Python/" class="nav-link"><i class="undefined"></i>
  Python
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签云
</a></div><div class="nav-item"><a href="/essay/" class="nav-link"><i class="iconfont reco-suggestion"></i>
  随笔
</a></div><div class="nav-item"><a href="/tools/" class="nav-link"><i class="iconfont reco-search"></i>
  工具
</a></div><div class="nav-item"><a href="/timeLine/" class="nav-link"><i class="iconfont reco-date"></i>
  时间线
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      联系我
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/lyandut" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://blog.csdn.net/llllllyyy" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-csdn"></i>
  CSDN
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://www.zhihu.com/people/li-yan-44-55-45" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-zhihu"></i>
  知乎
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <a href="https://github.com/lyandut/MyVuepressBlog" target="_blank" rel="noopener noreferrer" class="repo-link"><i class="iconfont reco-github"></i>
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav> <!----> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-25ba6db2 data-v-1aefc0b4><h3 class="title" data-v-25ba6db2 data-v-25ba6db2>智能指针shared_ptr踩坑笔记</h3> <!----> <label id="box" class="inputBox" data-v-25ba6db2 data-v-25ba6db2><input type="password" value="" data-v-25ba6db2> <span data-v-25ba6db2>Konck! Knock!</span> <button data-v-25ba6db2>OK</button></label> <div class="footer" data-v-25ba6db2 data-v-25ba6db2><span data-v-25ba6db2><i class="iconfont reco-theme" data-v-25ba6db2></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-25ba6db2>vuePress-theme-reco</a></span> <span data-v-25ba6db2><i class="iconfont reco-copyright" data-v-25ba6db2></i> <a data-v-25ba6db2><span data-v-25ba6db2>回廊识路</span>
            
          <!---->
          2022
        </a></span></div></div> <div data-v-1aefc0b4><main class="page"><section><div class="page-title"><h1 class="title">智能指针shared_ptr踩坑笔记</h1> <div data-v-f875f3fc><i class="iconfont reco-account" data-v-f875f3fc><span data-v-f875f3fc>回廊识路</span></i> <i class="iconfont reco-date" data-v-f875f3fc><span data-v-f875f3fc>11/13/2020</span></i> <!----> <i class="tags iconfont reco-tag" data-v-f875f3fc><span class="tag-item" data-v-f875f3fc>C++</span></i></div></div> <div class="theme-reco-content content__default"><div class="custom-block tip"><p class="title">智能指针</p><p>平时写代码一直避免使用指针，但在某些场景下指针的使用还是有必要的。最近在项目中简单使用了一下智能指针（<code>shared_ptr</code>），结果踩了不少坑，差点就爬不出来了。痛定思痛抱着《Cpp Primer》啃了两天，看书的时候才发现自己的理解和实践很浅薄，真的是有种后背发凉的感觉。。。特地记录下这些坑点，且警后人（指后来的自己=。=）。</p></div> <h2 id="写在前面"><a href="#写在前面" class="header-anchor">#</a> 写在前面……</h2> <p>本次实验基于的数据结构定义如下：</p> <p>基类<code>Polygon</code>的成员<code>_points</code>是一个<code>shared_ptr</code>，指向动态分配的<code>vector&lt;Point&gt;</code>，这样实现了在<code>Polygon</code>对象的多个拷贝之间共享相同的<code>vector&lt;Point&gt;</code>。基于<code>Polygon</code>实现了<code>Rect</code>和<code>Circle</code>两个子类。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;vector&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;memory&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cassert&gt;</span></span>

<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">constexpr</span> <span class="token keyword">double</span> PI <span class="token operator">=</span> <span class="token number">3.14</span><span class="token punctuation">;</span>

<span class="token keyword">using</span> coord_t <span class="token operator">=</span> <span class="token keyword">double</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">Point</span> <span class="token punctuation">{</span> coord_t x<span class="token punctuation">,</span> y<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Polygon</span> <span class="token punctuation">{</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">Polygon</span><span class="token punctuation">(</span><span class="token keyword">const</span> vector<span class="token operator">&lt;</span>Point<span class="token operator">&gt;</span> <span class="token operator">&amp;</span>points<span class="token punctuation">)</span> <span class="token operator">:</span>
        <span class="token function">_points</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">const</span> vector<span class="token operator">&lt;</span>Point<span class="token operator">&gt;&gt;</span></span></span><span class="token punctuation">(</span>points<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token keyword">virtual</span> string <span class="token function">shape</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">virtual</span> coord_t <span class="token function">area</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token keyword">const</span> shared_ptr<span class="token operator">&lt;</span><span class="token keyword">const</span> vector<span class="token operator">&lt;</span>Point<span class="token operator">&gt;&gt;</span> _points<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Rect</span> <span class="token keyword">final</span> <span class="token operator">:</span> <span class="token keyword">public</span> Polygon <span class="token punctuation">{</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">Rect</span><span class="token punctuation">(</span><span class="token keyword">const</span> vector<span class="token operator">&lt;</span>Point<span class="token operator">&gt;</span> <span class="token operator">&amp;</span>points<span class="token punctuation">,</span> coord_t width<span class="token punctuation">,</span> coord_t height<span class="token punctuation">)</span> <span class="token operator">:</span>
        <span class="token function">Polygon</span><span class="token punctuation">(</span>points<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_width</span><span class="token punctuation">(</span>width<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_height</span><span class="token punctuation">(</span>height<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">assert</span><span class="token punctuation">(</span>points<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    string <span class="token function">shape</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token string">&quot;Rect&quot;</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    coord_t <span class="token function">area</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> _width <span class="token operator">*</span> _height<span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token keyword">const</span> coord_t _width<span class="token punctuation">;</span>
    <span class="token keyword">const</span> coord_t _height<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Circle</span> <span class="token keyword">final</span> <span class="token operator">:</span> <span class="token keyword">public</span> Polygon <span class="token punctuation">{</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">Circle</span><span class="token punctuation">(</span><span class="token keyword">const</span> vector<span class="token operator">&lt;</span>Point<span class="token operator">&gt;</span> <span class="token operator">&amp;</span>points<span class="token punctuation">,</span> coord_t radius<span class="token punctuation">)</span> <span class="token operator">:</span>
        <span class="token function">Polygon</span><span class="token punctuation">(</span>points<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_center</span><span class="token punctuation">(</span>points<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_radius</span><span class="token punctuation">(</span>radius<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">assert</span><span class="token punctuation">(</span>points<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    string <span class="token function">shape</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token string">&quot;Circle&quot;</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    coord_t <span class="token function">area</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> PI <span class="token operator">*</span> _radius <span class="token operator">*</span> _radius<span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token keyword">const</span> Point _center<span class="token punctuation">;</span>
    <span class="token keyword">const</span> coord_t _radius<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">using</span> polygon_ptr <span class="token operator">=</span> shared_ptr<span class="token operator">&lt;</span>Polygon<span class="token operator">&gt;</span><span class="token punctuation">;</span>

<span class="token keyword">using</span> rect_ptr <span class="token operator">=</span> shared_ptr<span class="token operator">&lt;</span>Rect<span class="token operator">&gt;</span><span class="token punctuation">;</span>

<span class="token keyword">using</span> circle_ptr <span class="token operator">=</span> shared_ptr<span class="token operator">&lt;</span>Circle<span class="token operator">&gt;</span><span class="token punctuation">;</span>

<span class="token comment">// 定义一个边长为5的矩形和一个半径为5的圆.</span>
<span class="token keyword">static</span> vector<span class="token operator">&lt;</span>Point<span class="token operator">&gt;</span> r_points<span class="token punctuation">{</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> coord_t r_width <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span> r_height <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> vector<span class="token operator">&lt;</span>Point<span class="token operator">&gt;</span> c_points<span class="token punctuation">{</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> coord_t c_radius <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br></div></div><h2 id="从正确定义智能指针开始"><a href="#从正确定义智能指针开始" class="header-anchor">#</a> 从正确定义智能指针开始……</h2> <p>在项目中采用智能指针的初衷是为了实现多个对象之间共享数据，避免拷贝造成的开销。然而在使用的时候，我竟然连定义一个智能指针都能制造出五花八门的错误。。。下面分别整理了正确和错误的用法。</p> <h3 id="_1-make-shared函数-最安全的分配和使用动态内存的方法"><a href="#_1-make-shared函数-最安全的分配和使用动态内存的方法" class="header-anchor">#</a> 1. <code>make_shared</code>函数：最安全的分配和使用动态内存的方法</h3> <p>类似顺序容器的<code>emplace</code>成员，<code>make_shared</code>用其参数来构造给定类型的对象。可以是一般的构造函数：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>shared_ptr<span class="token operator">&lt;</span>Rect<span class="token operator">&gt;</span> p1 <span class="token operator">=</span> <span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>Rect<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>r_points<span class="token punctuation">,</span> r_width<span class="token punctuation">,</span> r_height<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>也可以是拷贝构造函数：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>Rect <span class="token function">rect_2</span><span class="token punctuation">(</span>r_points<span class="token punctuation">,</span> r_width<span class="token punctuation">,</span> r_height<span class="token punctuation">)</span><span class="token punctuation">;</span>
shared_ptr<span class="token operator">&lt;</span>Rect<span class="token operator">&gt;</span> p2 <span class="token operator">=</span> <span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>Rect<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>rect_2<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="custom-block warning"><p class="title">注意</p><p>需要说明的一点是，由于<code>p2</code>指向的对象（即<code>*p2</code>）是<code>rect_2</code>的拷贝，所以它们的<code>_points</code>成员指向相同的内存，共享相同的<code>vector&lt;Point&gt;</code>。而这个<code>vector&lt;Point&gt;</code>是<code>r_points</code>的一份拷贝，保存在动态内存中。</p></div><h3 id="_2-shared-ptr和new结合使用"><a href="#_2-shared-ptr和new结合使用" class="header-anchor">#</a> 2. <code>shared_ptr</code>和<code>new</code>结合使用</h3> <p>可以用<code>new</code>返回的指针来初始化智能指针：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>shared_ptr<span class="token operator">&lt;</span>Rect<span class="token operator">&gt;</span> <span class="token function">p3</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">Rect</span><span class="token punctuation">(</span>r_points<span class="token punctuation">,</span> r_width<span class="token punctuation">,</span> r_height<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>或者将一个<code>shared_ptr</code>绑定到一个已经定义的普通指针：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>Rect <span class="token operator">*</span>x <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">Rect</span><span class="token punctuation">(</span>r_points<span class="token punctuation">,</span> r_width<span class="token punctuation">,</span> r_height<span class="token punctuation">)</span><span class="token punctuation">;</span>
shared_ptr<span class="token operator">&lt;</span>Rect<span class="token operator">&gt;</span> <span class="token function">p4</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
x <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="custom-block warning"><p class="title">这是一种不建议的写法</p><p>原则上当<code>p4</code>绑定到<code>x</code>时，内存管理的责任就交给了<code>p4</code>，就不应该再使用<code>x</code>来访问<code>p4</code>指向的内存了。因此建议在完成绑定之后立刻将<code>x</code>置为空指针<code>nullptr</code>，避免在后续代码中使用<code>delete x</code>释放<code>p4</code>所指的内存，或者又将其他智能指针绑定到<code>x</code>上，这都会造成同一块内存多次释放的错误。</p> <p>但这就出现一个尴尬的情况：程序员要时刻记得一个已经存在的变量不能使用，这要求实在是高了点。。。最理想的还是不要制造出<code>x</code>，或者说<code>x</code>的存在就没有意义。</p></div><h3 id="_3-【错误1】试图从raw指针隐式转换到智能指针"><a href="#_3-【错误1】试图从raw指针隐式转换到智能指针" class="header-anchor">#</a> 3. 【错误1】试图从raw指针隐式转换到智能指针</h3> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>shared_ptr<span class="token operator">&lt;</span>Rect<span class="token operator">&gt;</span> p5 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">Rect</span><span class="token punctuation">(</span>r_points<span class="token punctuation">,</span> r_width<span class="token punctuation">,</span> r_height<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// !!!</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>【修改】接受指针参数的智能指针构造函数是<code>explicit</code>的，必须使用直接初始化形式：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>shared_ptr<span class="token operator">&lt;</span>Rect<span class="token operator">&gt;</span> <span class="token function">p5</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">Rect</span><span class="token punctuation">(</span>r_points<span class="token punctuation">,</span> r_width<span class="token punctuation">,</span> r_height<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="_4-【错误2】将非动态分配的内存托管给智能指针"><a href="#_4-【错误2】将非动态分配的内存托管给智能指针" class="header-anchor">#</a> 4. 【错误2】将非动态分配的内存托管给智能指针</h3> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>Rect <span class="token function">rect_6</span><span class="token punctuation">(</span>r_points<span class="token punctuation">,</span> r_width<span class="token punctuation">,</span> r_height<span class="token punctuation">)</span><span class="token punctuation">;</span>
shared_ptr<span class="token operator">&lt;</span>Rect<span class="token operator">&gt;</span> <span class="token function">p6</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rect_6<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// !!!</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>这种写法将<code>p6</code>指向一块<strong>栈内存</strong>，相当于局部变量<code>rect_6</code>和<code>p6</code>管理了同一内存空间，而栈内存中的对象是编译器负责创建和销毁的，而且不能析构一个指向非动态分配的内存的智能指针，因此是不合理的。</p> <p>【修改】创建智能指针时<strong>传递一个空的删除器函数</strong>或者<strong>直接使用raw指针</strong>，详见<a href="https://stackoverflow.com/questions/24049155/set-shared-ptr-to-point-existing-object" target="_blank" rel="noopener noreferrer">stackoverflow<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。正如回答中说的：<em>There is not much point in using a <code>shared_ptr</code> for an automatically allocated object.</em></p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>Rect <span class="token function">rect_6</span><span class="token punctuation">(</span>r_points<span class="token punctuation">,</span> r_width<span class="token punctuation">,</span> r_height<span class="token punctuation">)</span><span class="token punctuation">;</span>
shared_ptr<span class="token operator">&lt;</span>Rect<span class="token operator">&gt;</span> <span class="token function">p6</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rect_6<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span>Rect<span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="_5-【错误3】将同一份动态内存托管给多个智能指针"><a href="#_5-【错误3】将同一份动态内存托管给多个智能指针" class="header-anchor">#</a> 5. 【错误3】将同一份动态内存托管给多个智能指针</h3> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>Rect <span class="token operator">*</span>xx <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">Rect</span><span class="token punctuation">(</span>r_points<span class="token punctuation">,</span> r_width<span class="token punctuation">,</span> r_height<span class="token punctuation">)</span><span class="token punctuation">;</span>
shared_ptr<span class="token operator">&lt;</span>Rect<span class="token operator">&gt;</span> <span class="token function">p7</span><span class="token punctuation">(</span>xx<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">{</span>
    shared_ptr<span class="token operator">&lt;</span>Rect<span class="token operator">&gt;</span> <span class="token function">p8</span><span class="token punctuation">(</span>xx<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// !!!</span>
    shared_ptr<span class="token operator">&lt;</span>Rect<span class="token operator">&gt;</span> <span class="token function">p9</span><span class="token punctuation">(</span>p7<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// !!!</span>
<span class="token punctuation">}</span>
xx <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
Rect rect_7 <span class="token operator">=</span> <span class="token operator">*</span>p7<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><code>p7</code>、<code>p8</code>和<code>p9</code>指向了相同的动态内存，但由于它们是相互独立创建的，<strong>因此各自的引用计数都是1</strong>，即相互不知道对方的存在，认为自己是这块内存的唯一管理者。当<code>p8</code>、<code>p9</code>所在程序块结束时，内存被释放，从而导致<code>p7</code>变为<strong>空悬指针</strong>，意味着当试图使用<code>p7</code>时将发生未定义的行为；而且也存在同一内存多次释放的危险。</p> <p><em>Ps：在测试中还发现这种多个智能指针托管同一动态内存的情况与上文智能指针指向栈内存的情况，二者报错信息并不相同。</em></p> <p>【修改】与错误2类似，在创建智能指针时<strong>传递一个空的删除器函数</strong>即可。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>Rect <span class="token operator">*</span>xx <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">Rect</span><span class="token punctuation">(</span>r_points<span class="token punctuation">,</span> r_width<span class="token punctuation">,</span> r_height<span class="token punctuation">)</span><span class="token punctuation">;</span>
shared_ptr<span class="token operator">&lt;</span>Rect<span class="token operator">&gt;</span> <span class="token function">p7</span><span class="token punctuation">(</span>xx<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">{</span>
    shared_ptr<span class="token operator">&lt;</span>Rect<span class="token operator">&gt;</span> <span class="token function">p8</span><span class="token punctuation">(</span>xx<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span>Rect<span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    shared_ptr<span class="token operator">&lt;</span>Rect<span class="token operator">&gt;</span> <span class="token function">p9</span><span class="token punctuation">(</span>p7<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span>Rect<span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
xx <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
Rect rect_7 <span class="token operator">=</span> <span class="token operator">*</span>p7<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><div class="custom-block warning"><p class="title">小结</p><p>本质上4和5属于同一类型的错误，即同一块内存由多个管理者托管，但它们彼此之间又不知道对方的存在，这样就导致在它们各自生命周期结束时都会释放这块内存的错误。个人认为，5的正确写法在某种程度上还是可以接受的，但4是一种完全不合理的智能指针使用方式，这种情况就应该直接使用raw指针，“只有将指向动态分配的对象的指针交给<code>shared_ptr</code>托管才是有意义的”。</p> <p>往往这种错误在编译期间没有问题，但运行时会报错，因此不易排查。为了避免这种错误，应该养成良好的编程意识，《Cpp Primer》中提到几条基本规范，建议严格遵循：</p> <ul><li>不使用相同的raw指针初始化（或reset）多个智能指针。</li> <li>不delete get()返回的指针。</li> <li>不使用get()初始化或reset另一个智能指针。</li> <li>如果你使用get()返回的指针，记住当最后一个对应的智能指针销毁后，你的指针就变为无效了。</li> <li>如果你使用智能指针管理的资源不是new分配的内存，记住传递给它一个删除器。</li></ul></div><h2 id="智能指针的使用场景"><a href="#智能指针的使用场景" class="header-anchor">#</a> 智能指针的使用场景</h2> <p>《Cpp Primer》中提到程序使用动态内存出于以下三种原因之一：</p> <blockquote><ol><li>程序不知道自己需要使用多少对象</li> <li>程序不知道所需对象的准确类型</li> <li>程序需要在多个对象间共享数据</li></ol></blockquote> <p>容器类是出于第一种原因而使用动态内存的典型例子，而2和3的需求可以使用（智能）指针很好地满足。</p> <h3 id="智能指针成员"><a href="#智能指针成员" class="header-anchor">#</a> 智能指针成员</h3> <p>基类<code>Polygon</code>中的<code>_points</code>成员是一个<code>shared_ptr</code>智能指针，依靠它实现了<code>Polygon</code>对象的不同拷贝之间共享相同的<code>vector&lt;Point&gt;</code>，并且此成员将记录有多少个对象共享了相同的<code>vector&lt;Point&gt;</code>，并且能在最后一个使用者被销毁时释放该内存。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>Rect <span class="token function">rect_1</span><span class="token punctuation">(</span>r_points<span class="token punctuation">,</span> r_width<span class="token punctuation">,</span> r_height<span class="token punctuation">)</span><span class="token punctuation">;</span>
cout <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;rect_1 points成员地址: &quot;</span> <span class="token operator">&lt;&lt;</span> rect_1<span class="token punctuation">.</span>_points<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
cout <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;rect_1 points引用计数: &quot;</span> <span class="token operator">&lt;&lt;</span> rect_1<span class="token punctuation">.</span>_points<span class="token punctuation">.</span><span class="token function">use_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>

Rect rect_2 <span class="token operator">=</span> rect_1<span class="token punctuation">;</span>
cout <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;rect_2 points成员地址: &quot;</span> <span class="token operator">&lt;&lt;</span> rect_2<span class="token punctuation">.</span>_points<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
cout <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;rect_2 points引用计数: &quot;</span> <span class="token operator">&lt;&lt;</span> rect_2<span class="token punctuation">.</span>_points<span class="token punctuation">.</span><span class="token function">use_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>上述代码的运行结果：</p> <p><img src="/assets/img/smartptr_member.af0bf885.png" alt="smartptr_member"></p> <h3 id="容器与继承"><a href="#容器与继承" class="header-anchor">#</a> 容器与继承</h3> <p>当我们使用容器存放继承体系中的对象时，因为不允许直接在容器中保存不同类型的元素，通常必须采取间接存储的方式，即我们实际上存放的是基类的（智能）指针，这些指针所指的对象可以是基类对象，也可以是派生类对象。当要使用具体的对象时，要利用多态性将基类指针下行转换为派生类指针。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>vector<span class="token operator">&lt;</span>polygon_ptr<span class="token operator">&gt;</span> polygon_ptrs<span class="token punctuation">;</span>
polygon_ptrs<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>Rect<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>r_points<span class="token punctuation">,</span> r_width<span class="token punctuation">,</span> r_height<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
polygon_ptrs<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>Circle<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>c_points<span class="token punctuation">,</span> c_radius<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//auto rect = dynamic_cast&lt;Rect*&gt;(polygon_ptrs.front()); // compile error</span>
<span class="token comment">//auto rect = dynamic_cast&lt;rect_ptr&gt;(polygon_ptrs.front()); // compile error</span>
<span class="token keyword">auto</span> rect <span class="token operator">=</span> <span class="token generic-function"><span class="token function">dynamic_pointer_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>Rect<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>polygon_ptrs<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// compile success</span>
cout <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;polygon_ptrs.front() shape: &quot;</span> <span class="token operator">&lt;&lt;</span> rect<span class="token operator">-&gt;</span><span class="token function">shape</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">&quot; area: &quot;</span> <span class="token operator">&lt;&lt;</span> rect<span class="token operator">-&gt;</span><span class="token function">area</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
<span class="token keyword">auto</span> circle <span class="token operator">=</span> <span class="token generic-function"><span class="token function">dynamic_pointer_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>Circle<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>polygon_ptrs<span class="token punctuation">.</span><span class="token function">back</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
cout <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;polygon_ptrs.back() shape: &quot;</span> <span class="token operator">&lt;&lt;</span> circle<span class="token operator">-&gt;</span><span class="token function">shape</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">&quot; area: &quot;</span> <span class="token operator">&lt;&lt;</span> circle<span class="token operator">-&gt;</span><span class="token function">area</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>上述代码的运行结果：</p> <p><img src="data:image/png;base64,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" alt="smartptr_polymorphism"></p> <div class="custom-block warning"><p class="title">智能指针的下行转换</p><ol><li>必须使用<code>dynamic_pointer_cast</code>，而不是<code>dynamic_cast</code>。这是因为父子两种智能指针并非继承关系，而是完全不同的类型。</li> <li>基类必须是多态类型（包含虚函数）。</li></ol></div><h2 id="github-代码"><a href="#github-代码" class="header-anchor">#</a> [Github] 代码</h2> <p>项目实例均在vs2017上测试，并上传至<a href="https://github.com/lyandut/MyCppPitfalls" target="_blank" rel="noopener noreferrer">GitHub<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <h2 id="reference-参考"><a href="#reference-参考" class="header-anchor">#</a> [Reference] 参考</h2> <p><a href="https://stackoverflow.com/questions/24049155/set-shared-ptr-to-point-existing-object" target="_blank" rel="noopener noreferrer">Stack Overflow: Set shared_ptr to point existing object<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://www.cnblogs.com/liushui-sky/p/13632028.html" target="_blank" rel="noopener noreferrer">C++11 shared_ptr（智能指针）详解<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div></section> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/lyandut/MyVuepressBlog/edit/reco/docs/cpp/智能指针shared_ptr踩坑笔记.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">1/23/2021, 11:27:13 AM</span></div></footer> <!----> <div class="comments-wrapper"><!----></div> <ul class="side-bar sub-sidebar-wrapper" style="width:12rem;" data-v-cb1513f6><li class="level-2" data-v-cb1513f6><a href="/cpp/zhi-neng-zhi-zhen-shared_ptrcai-keng-bi-ji.html#写在前面" class="sidebar-link reco-side-写在前面" data-v-cb1513f6>写在前面……</a></li><li class="level-2" data-v-cb1513f6><a href="/cpp/zhi-neng-zhi-zhen-shared_ptrcai-keng-bi-ji.html#从正确定义智能指针开始" class="sidebar-link reco-side-从正确定义智能指针开始" data-v-cb1513f6>从正确定义智能指针开始……</a></li><li class="level-3" data-v-cb1513f6><a href="/cpp/zhi-neng-zhi-zhen-shared_ptrcai-keng-bi-ji.html#_1-make-shared函数-最安全的分配和使用动态内存的方法" class="sidebar-link reco-side-_1-make-shared函数-最安全的分配和使用动态内存的方法" data-v-cb1513f6>1. make_shared函数：最安全的分配和使用动态内存的方法</a></li><li class="level-3" data-v-cb1513f6><a href="/cpp/zhi-neng-zhi-zhen-shared_ptrcai-keng-bi-ji.html#_2-shared-ptr和new结合使用" class="sidebar-link reco-side-_2-shared-ptr和new结合使用" data-v-cb1513f6>2. shared_ptr和new结合使用</a></li><li class="level-3" data-v-cb1513f6><a href="/cpp/zhi-neng-zhi-zhen-shared_ptrcai-keng-bi-ji.html#_3-【错误1】试图从raw指针隐式转换到智能指针" class="sidebar-link reco-side-_3-【错误1】试图从raw指针隐式转换到智能指针" data-v-cb1513f6>3. 【错误1】试图从raw指针隐式转换到智能指针</a></li><li class="level-3" data-v-cb1513f6><a href="/cpp/zhi-neng-zhi-zhen-shared_ptrcai-keng-bi-ji.html#_4-【错误2】将非动态分配的内存托管给智能指针" class="sidebar-link reco-side-_4-【错误2】将非动态分配的内存托管给智能指针" data-v-cb1513f6>4. 【错误2】将非动态分配的内存托管给智能指针</a></li><li class="level-3" data-v-cb1513f6><a href="/cpp/zhi-neng-zhi-zhen-shared_ptrcai-keng-bi-ji.html#_5-【错误3】将同一份动态内存托管给多个智能指针" class="sidebar-link reco-side-_5-【错误3】将同一份动态内存托管给多个智能指针" data-v-cb1513f6>5. 【错误3】将同一份动态内存托管给多个智能指针</a></li><li class="level-2" data-v-cb1513f6><a href="/cpp/zhi-neng-zhi-zhen-shared_ptrcai-keng-bi-ji.html#智能指针的使用场景" class="sidebar-link reco-side-智能指针的使用场景" data-v-cb1513f6>智能指针的使用场景</a></li><li class="level-3" data-v-cb1513f6><a href="/cpp/zhi-neng-zhi-zhen-shared_ptrcai-keng-bi-ji.html#智能指针成员" class="sidebar-link reco-side-智能指针成员" data-v-cb1513f6>智能指针成员</a></li><li class="level-3" data-v-cb1513f6><a href="/cpp/zhi-neng-zhi-zhen-shared_ptrcai-keng-bi-ji.html#容器与继承" class="sidebar-link reco-side-容器与继承" data-v-cb1513f6>容器与继承</a></li><li class="level-2" data-v-cb1513f6><a href="/cpp/zhi-neng-zhi-zhen-shared_ptrcai-keng-bi-ji.html#github-代码" class="sidebar-link reco-side-github-代码" data-v-cb1513f6>[Github] 代码</a></li><li class="level-2" data-v-cb1513f6><a href="/cpp/zhi-neng-zhi-zhen-shared_ptrcai-keng-bi-ji.html#reference-参考" class="sidebar-link reco-side-reference-参考" data-v-cb1513f6>[Reference] 参考</a></li></ul></main> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/assets/js/app.dd25fc47.js" defer></script><script src="/assets/js/3.ea75390b.js" defer></script><script src="/assets/js/1.09e6effb.js" defer></script><script src="/assets/js/17.6526aea9.js" defer></script>
  </body>
</html>
